<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Academy | Secure Payment</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma}
body{
  background:linear-gradient(135deg,#006400,#00a86b);
  min-height:100vh;
}
.container{
  max-width:600px;
  margin:20px auto;
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  overflow:hidden;
}
header{
  background:#006400;
  color:#fff;
  padding:22px;
  text-align:center;
}
header h1{
  font-size:24px;
  display:flex;
  justify-content:center;
  gap:10px;
}
.content{padding:25px}
.section-title{
  color:#006400;
  font-size:18px;
  margin:18px 0 10px;
  border-bottom:2px solid #eee;
  padding-bottom:6px;
}
.input-group{margin-bottom:14px}
label{font-weight:600;margin-bottom:5px;display:block}
input{
  width:100%;
  padding:12px;
  border:2px solid #ddd;
  border-radius:8px;
  font-size:15px;
}
.course-box{
  background:#e6f7ee;
  padding:15px;
  border-radius:10px;
  margin-bottom:18px;
}
.course-box h3{color:#006400}
.course-box p{font-weight:700;color:#00a86b}
button{
  width:100%;
  background:#006400;
  color:#fff;
  border:none;
  padding:14px;
  border-radius:10px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}
button:hover{background:#008554}
button:disabled{opacity:.6}
.loading{text-align:center;display:none;margin-top:15px}
.spinner{
  width:30px;height:30px;
  border:4px solid #ccc;
  border-left:4px solid #006400;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}
@keyframes spin{to{transform:rotate(360deg)}}
.status{display:none;margin-top:15px;font-weight:700}
.success{
  display:none;
  background:#e6f7ee;
  margin-top:20px;
  padding:20px;
  border-radius:12px;
  text-align:center;
}
.notification{
  position:fixed;
  top:20px;
  right:20px;
  padding:12px 18px;
  border-radius:8px;
  color:#fff;
  font-weight:700;
  opacity:0;
  transform:translateX(100%);
  transition:.3s;
}
.notification.success{background:#00a86b;opacity:1;transform:none}
.notification.error{background:#e00;opacity:1;transform:none}

/* RECEIPT */
.receipt-box{
  max-width:420px;
  margin:25px auto;
  padding:25px;
  border:2px dashed #006400;
  border-radius:12px;
  background:#fff;
  font-size:14px;
}
.receipt-box h2{text-align:center;color:#006400}
.receipt-box hr{border:none;border-top:1px dashed #ccc;margin:12px 0}
.receipt-box .stamp{text-align:center;color:#006400;font-weight:800}

/* PRINT */
@media print{
  body *{visibility:hidden}
  #receipt, #receipt *{visibility:visible}
  #receipt{position:absolute;left:0;top:0;width:100%}
  button{display:none}
}
footer{text-align:center;color:#fff;margin:15px 0;opacity:.85}
</style>
</head>

<body>

<div class="container">
<header>
<h1><i class="fas fa-graduation-cap"></i> AI Academy</h1>
<p>Secure Course Enrollment</p>
</header>

<div class="content">

<div class="course-box">
<h3 id="courseName">â€”</h3>
<p id="coursePrice">KES â€”</p>
</div>

<h3 class="section-title">Student Details</h3>

<div class="input-group"><label>Full Name</label><input id="name"></div>
<div class="input-group"><label>Email</label><input id="email" type="email"></div>
<div class="input-group"><label>WhatsApp Number</label><input id="whatsapp"></div>
<div class="input-group"><label>Other Contact</label><input id="other"></div>

<h3 class="section-title">Payment</h3>
<div class="input-group"><label>M-Pesa Number</label><input id="phone"></div>

<input type="hidden" id="course">
<input type="hidden" id="amount">

<button id="payBtn">Pay & Enroll</button>

<div class="loading" id="loading"><div class="spinner"></div><p>Waiting for PIN confirmationâ€¦</p></div>
<div class="status" id="status">Processingâ€¦</div>

<div class="success" id="success">
<h3>âœ… Payment Successful</h3>
<p>Your course is unlocked.</p>
<a href="dashboard.html" style="font-weight:700;color:#006400">Go to Dashboard</a>
</div>

<!-- RECEIPT -->
<div id="receipt" style="display:none">
<div class="receipt-box">
<h2>AI Academy</h2>
<hr>
<p><b>Receipt:</b> <span id="r_receipt"></span></p>
<p><b>Date:</b> <span id="r_date"></span></p>
<hr>
<p><b>Name:</b> <span id="r_name"></span></p>
<p><b>Email:</b> <span id="r_email"></span></p>
<p><b>WhatsApp:</b> <span id="r_whatsapp"></span></p>
<hr>
<p><b>Course:</b> <span id="r_course"></span></p>
<p><b>Amount:</b> KES <span id="r_amount"></span></p>
<hr>
<p class="stamp">âœ” PAID & VERIFIED</p>
<button onclick="window.print()">ðŸ–¨ Print Receipt</button>
</div>
</div>

</div>
</div>

<div class="notification" id="notify"></div>
<footer>&copy; 2026 AI Academy</footer>

<script>
const API = "https://mpesapi.giftedtech.co.ke";

/* TELEGRAM (TEMP â€“ CHANGE IN PROD) */
const TELEGRAM_BOT_TOKEN = "8580631453:AAGwjFTRUJd9lbV_cqY1oeTxTgjiYUykNkA";
const TELEGRAM_CHAT_ID  = "5547937090";

/* ELEMENT HELPERS */
const $ = id => document.getElementById(id);

/* LOAD COURSE */
const params = new URLSearchParams(location.search);
$("course").value = params.get("course") || "";
$("amount").value = params.get("price") || "";
$("courseName").textContent = ($("course").value || "").replace(/_/g," ").toUpperCase();
$("coursePrice").textContent = "KES " + ($("amount").value || "");

/* NOTIFY */
function notify(msg,type){
  const n = $("notify");
  n.textContent = msg;
  n.className = "notification " + type;
  setTimeout(()=>n.className="notification",3000);
}

/* PHONE NORMALIZER */
function normalizePhone(v){
  v = (v || "").toString().trim();
  if(/^(07|01)\d{8}$/.test(v)) return "254" + v.substring(1);
  if(/^254(7|1)\d{8}$/.test(v)) return v;
  return null;
}

/* PAY */
$("payBtn").addEventListener("click", async () => {

  const user = {
    name: ($("name")?.value || "").trim(),
    email: ($("email")?.value || "").trim(),
    whatsapp: normalizePhone($("whatsapp")?.value),
    other: ($("other")?.value || "").trim()
  };

  const phone  = normalizePhone($("phone")?.value);
  const amount = $("amount").value;
  const course = $("course").value;

  if(!user.name || !user.email || !user.whatsapp){
    notify("Please fill all required details","error");
    return;
  }

  if(!phone){
    notify("Invalid M-Pesa number","error");
    return;
  }

  $("payBtn").disabled = true;
  $("loading").style.display = "block";
  $("status").style.display = "block";
  $("status").textContent = "Waiting for PIN confirmationâ€¦";

  try{
    const res = await fetch(API + "/api/payJay.php",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ phoneNumber: phone, amount })
    });

    const data = await res.json();

    if(data.success){
      pollStatus(data.CheckoutRequestID, user);
    }else{
      handleFail();
    }

  }catch{
    handleFail();
  }
});

/* POLL â€“ MPESA SAFE FLOW */
function pollStatus(id, user){
  let attempts = 0;
  const MAX = 15; // 75 seconds

  const timer = setInterval(async()=>{
    attempts++;

    try{
      const res = await fetch(API + "/api/verify-transaction.php",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ checkoutRequestId: id })
      });

      const d = await res.json();
      $("status").textContent = "Status: " + d.status;

      if(d.status === "completed"){
        clearInterval(timer);
        handleSuccess(d, user);
      }

      if(d.status === "failed" && attempts >= MAX){
        clearInterval(timer);
        handleFail();
      }

    }catch{
      if(attempts >= MAX){
        clearInterval(timer);
        handleFail();
      }
    }
  },5000);
}

/* SUCCESS */
function handleSuccess(d, user){
  $("loading").style.display = "none";
  $("success").style.display = "block";

  $("r_receipt").textContent = d.mpesaReceipt || "N/A";
  $("r_date").textContent = new Date().toLocaleString();
  $("r_name").textContent = user.name;
  $("r_email").textContent = user.email;
  $("r_whatsapp").textContent = user.whatsapp;
  $("r_course").textContent = $("course").value.replace(/_/g," ");
  $("r_amount").textContent = $("amount").value;
  $("receipt").style.display = "block";

  sendTelegram(user, d.mpesaReceipt || "N/A");
  notify("Payment successful","success");
}

/* FAIL */
function handleFail(){
  notify("Payment not completed. Please retry.","error");
  $("payBtn").disabled = false;
  $("loading").style.display = "none";
}

/* TELEGRAM */
function sendTelegram(u, receipt){
  fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      chat_id: TELEGRAM_CHAT_ID,
      text:
`AI ACADEMY PAYMENT
Name: ${u.name}
Email: ${u.email}
WhatsApp: ${u.whatsapp}
Course: ${$("course").value}
Amount: KES ${$("amount").value}
Receipt: ${receipt}`
    })
  });
}
</script>
</body>
</html>
